rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== USERS =====
    match /users/{userId} {
      allow read: if true;  // Public read for username lookup
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ===== QUIZ SESSIONS =====
    match /quiz_sessions/{sessionId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null;
      allow list: if request.auth != null;
    }
    
    // ===== LEADERBOARD =====
    match /leaderboard/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // ===== ALL OTHER COLLECTIONS =====
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // ===== CONVERSATIONS RULES (for production) =====
    // match /conversations/{conversationId} {
    //   allow read: if request.auth != null && 
    //                  request.auth.uid in resource.data.participantIds;
    //   allow create: if request.auth != null && 
    //                    request.auth.uid in request.resource.data.participantIds;
    //   allow update: if request.auth != null && 
    //                    request.auth.uid in resource.data.participantIds;
    //   allow delete: if false;
    // }
    
    // ===== MESSAGES RULES (for production) =====
    // match /messages/{messageId} {
    //   allow read: if request.auth != null;
    //   allow create: if request.auth != null && 
    //                    request.auth.uid == request.resource.data.senderId;
    //   allow update: if request.auth != null;
    //   allow delete: if request.auth != null && 
    //                    request.auth.uid == resource.data.senderId;
    // }
    
    // ===== PLAYLISTS RULES (for production) =====
    // match /playlists/{playlistId} {
    //   // Read: public playlists or owner or collaborators
    //   allow read: if resource.data.isPublic == true || 
    //                  request.auth.uid == resource.data.userId ||
    //                  request.auth.uid in resource.data.collaborators.keys();
    //   
    //   // Create: authenticated users
    //   allow create: if request.auth != null && 
    //                    request.auth.uid == request.resource.data.userId;
    //   
    //   // Update: owner or collaborators with editor/owner role
    //   allow update: if request.auth != null && (
    //     request.auth.uid == resource.data.userId ||
    //     (request.auth.uid in resource.data.collaborators.keys() &&
    //      resource.data.collaborators[request.auth.uid].role in ['owner', 'editor'])
    //   );
    //   
    //   // Delete: only owner
    //   allow delete: if request.auth != null && 
    //                    request.auth.uid == resource.data.userId;
    // }
    
    // ===== USERS RULES (for production) =====
    // match /users/{userId} {
    //   allow read: if request.auth != null;
    //   allow write: if request.auth != null && request.auth.uid == userId;
    //   
    //   // Subcollections
    //   match /reviews/{reviewId} {
    //     allow read: if true;
    //     allow write: if request.auth != null && request.auth.uid == userId;
    //   }
    //   
    //   match /pinnedTracks/{trackId} {
    //     allow read: if true;
    //     allow write: if request.auth != null && request.auth.uid == userId;
    //   }
    // }
  }
}
